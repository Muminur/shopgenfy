#!/bin/sh

# Security Check: Scan for potential secrets in staged files
echo "Running security checks..."

# Check for .env files in staging
ENV_FILES=$(git diff --cached --name-only | grep -E "^\.env|\.env\." || true)
if [ -n "$ENV_FILES" ]; then
  echo "ERROR: .env file(s) detected in staging!"
  echo "$ENV_FILES"
  echo "Remove with: git reset HEAD <file>"
  exit 1
fi

# Check for hardcoded secrets patterns in staged changes
SECRETS_CHECK=$(git diff --cached -U0 | grep -E "^\+" | grep -vE "^\+\+\+" | grep -iE "(api_key|apikey|secret_key|password|private_key|access_token|auth_token|credentials)['\"]?\s*[:=]\s*['\"][A-Za-z0-9_\-]{16,}['\"]" || true)
if [ -n "$SECRETS_CHECK" ]; then
  echo "ERROR: Potential hardcoded secrets detected!"
  echo "Review these lines:"
  echo "$SECRETS_CHECK"
  echo ""
  echo "If these are env var references (process.env.X), they are safe."
  echo "If these are actual secret values, remove them immediately."
  exit 1
fi

# Check for sensitive file patterns
SENSITIVE_FILES=$(git diff --cached --name-only | grep -E "\.(pem|key|p12|pfx)$|credentials\.json|service-account\.json|secrets\.(yaml|json)$" || true)
if [ -n "$SENSITIVE_FILES" ]; then
  echo "ERROR: Sensitive file type detected!"
  echo "$SENSITIVE_FILES"
  exit 1
fi

echo "Security checks passed."

# Run lint-staged
npx lint-staged
